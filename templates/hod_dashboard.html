{% extends "base.html" %}
{% block content %}
<div class="dashboard-head">
  <div>
    <h2>HOD Dashboard</h2>
    <p class="muted">Review requests, monitor activity, and track AI alerts in one place.</p>
  </div>
  <a href="{{ url_for('hod.logs') }}" class="btn">View Scan Logs</a>
</div>

<h3 class="section-title">Overview</h3>
<div class="stat-grid">
  <div class="stat-card">
    <div class="stat-label">Exits Today</div>
    <div class="stat-value">{{ total_exits_today }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Exits This Month</div>
    <div class="stat-value">{{ monthly_exit_count }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Approval rate</div>
    <div class="stat-value">{{ approval_rate }}%</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Odd-time exits</div>
    <div class="stat-value">{{ odd_time_count }}</div>
  </div>
</div>

<div class="grid-two">
  <div class="panel">
    <h3 class="panel-title">Section-wise Exit Distribution</h3>
    <table>
      <tr><th>Section</th><th>Count</th></tr>
      {% for row in section_distribution %}
      <tr>
        <td>{{ row.section }}</td>
        <td>{{ row.count }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>

  <div class="panel insights-panel">
    <h3 class="panel-title">AI Insights & Alerts</h3>

    <div class="alert-item critical">
      <div class="alert-title">High-risk students (Top 5)</div>
      {% if high_risk_students %}
      <ul>
        {% for name, count in high_risk_students %}
          <li>{{ name }} â€” {{ count }} requests</li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="muted">No high-risk trend detected.</p>
      {% endif %}
    </div>

    <div class="alert-item warning">
      <div class="alert-title">Unusual section activity</div>
      <p class="muted">{{ unusual_section or 'No unusual section activity detected.' }}</p>
    </div>

    <div class="alert-item info">
      <div class="alert-title">Abnormal time window</div>
      <p class="muted">{{ odd_time_count }} exits detected outside normal hours.</p>
    </div>

    <div class="alert-item neutral">
      <div class="alert-title">Faculty approval anomaly</div>
      <ul>
        {% for alert in lenient_alerts %}
          <li>{{ alert }}</li>
        {% endfor %}
        {% for alert in strict_alerts %}
          <li>{{ alert }}</li>
        {% endfor %}
        {% if not lenient_alerts and not strict_alerts %}
          <li>No anomaly detected.</li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

<div class="panel" style="margin-top:12px;">
  <h3 class="panel-title">Pending HOD Approvals</h3>
  <table>
    <tr>
      <th>ID</th>
      <th>Student</th>
      <th>Reason</th>
      <th>Requested</th>
      <th>Action</th>
    </tr>

    {% for p in passes %}
    <tr>
      <td>{{ p.id }}</td>
      <td>{{ p.student.name }}</td>
      <td>{{ p.reason }}</td>
      <td>{{ p.date_requested|dt_short }}</td>
      <td><a href="{{ url_for('hod.view_request', pass_id=p.id) }}">Review</a></td>
    </tr>
    {% endfor %}
  </table>
</div>

<div class="panel" style="margin-top:12px;">
  <h3 class="panel-title">Recent Security Scans</h3>
  <table>
    <tr>
      <th>Pass ID</th>
      <th>Student</th>
      <th>Out Time</th>
      <th>In Time</th>
    </tr>
    {% for p in past_scans %}
    <tr>
      <td>{{ p.id }}</td>
      <td>{{ p.student.name }}</td>
      <td>{{ p.exit_time|dt_short }}</td>
      <td>{{ p.entry_time|dt_short }}</td>
    </tr>
    {% endfor %}
  </table>
</div>

{% endblock %}
